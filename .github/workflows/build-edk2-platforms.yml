name: Build EDK2 platforms

on:
  # push: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        config: 
          - platformname: RPi3
            dscfile: edk2-platforms/Platform/RaspberryPi/RPi3/RPi3.dsc
            arch: AARCH64
          - platformname: RPi4
            dscfile: edk2-platforms/Platform/RaspberryPi/RPi4/RPi4.dsc
            arch: AARCH64
          - platformname: ArmJuno
            dscfile: edk2-platforms/Platform/ARM/JunoPkg/ArmJuno.dsc
            arch: AARCH64
          - platformname: Sgi575
            dscfile: edk2-platforms/Platform/ARM/SgiPkg/Sgi575/Sgi575.dsc
            arch: AARCH64
          - platformname: BeagleBoard
            dscfile: edk2-platforms/Platform/BeagleBoard/BeagleBoardPkg/BeagleBoardPkg.dsc
            arch: ARM
          - platformname: FreedomU500VC707
            dscfile: edk2-platforms/Platform/SiFive/U5SeriesPkg/FreedomU500VC707Board/U500.dsc
            arch: RISCV64
          - platformname: FreedomU540HiFiveUnleashed
            dscfile: edk2-platforms/Platform/SiFive/U5SeriesPkg/FreedomU540HiFiveUnleashedBoard/U540.dsc
            arch: RISCV64
          - platformname: DeveloperBox
            dscfile: edk2-platforms/Platform/Socionext/DeveloperBox/DeveloperBox.dsc
            arch: AARCH64
          - platformname: Quark
            dscfile: edk2-platforms/Platform/Intel/QuarkPlatformPkg/Quark.dsc
            arch: IA32
          - platformname: Vlv2TbltDevicePkgX64
            dscfile: edk2-platforms/Platform/Intel/Vlv2TbltDevicePkg/PlatformPkgX64.dsc 
            arch: X64 -a IA32
          # - platformname: DeveloperBoxMm
          #   dscfile: edk2-platforms/Platform/Socionext/DeveloperBox/DeveloperBoxMm.dsc
          #   arch: AARCH64
        buildtarget: 
          - RELEASE
          - DEBUG
    steps:
      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3.8 \
            uuid-dev \
            iasl \
            git \
            gcc \
            nasm \
            python3-distutils \
            gcc-arm-linux-gnueabi \
            gcc-aarch64-linux-gnu \
            gcc-riscv64-unknown-elf \
            device-tree-compiler \
            gcab
          sudo apt-get clean
          sudo ln -sf /usr/bin/python3.8 /usr/bin/python

      - uses: actions/checkout@v2
        with:
          submodules: true 
      - run: git submodule foreach git submodule update --init --force --depth=1

      # Run the build commands
      - run: |
          export GCC5_ARM_PREFIX=arm-linux-gnueabi-
          export GCC5_AARCH64_PREFIX=aarch64-linux-gnu-
          export GCC5_RISCV64_PREFIX=riscv64-unknown-elf-
          export WORKSPACE=$PWD
          export PACKAGES_PATH=$WORKSPACE/edk2:$WORKSPACE/edk2-platforms:$WORKSPACE/edk2-non-osi
          export PACKAGES_PATH=$PACKAGES_PATH:$WORKSPACE/edk2-platforms/Silicon/Intel:$WORKSPACE/edk2-platforms/Platform/Intel:$WORKSPACE/edk2-non-osi/Silicon/Intel:
          . edk2/edksetup.sh
          make -C edk2/BaseTools
          build \
            -n 2 \
            -b ${{ matrix.buildtarget }} \
            -t GCC5 \
            -p ${{ matrix.config.dscfile }} \
            -a ${{ matrix.config.arch }}

      - uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.config.platformname }}_${{ matrix.buildtarget }}_GCC5
          path: Build/*/${{ matrix.buildtarget }}_GCC5/FV/*.fd
